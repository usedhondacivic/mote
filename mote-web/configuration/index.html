<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <link rel="stylesheet" href="styles/third_party.css">
    <link rel="stylesheet" href="styles/index.css">

    <title>Mote Configuration</title>
    <script defer type="module">
        import {serial_connect, set_uid, network_connect, rescan} from './scripts/index.js'

        /* Spinners / loading */

        let long_spinners = document.querySelectorAll('.spinner');
        let short_spinners = document.querySelectorAll('.short_spinner');
        let long_spinner_state = 0;
        let long_spinner_states = ["⢀⠀", "⡀⠀", "⠄⠀", "⢂⠀", "⡂⠀", "⠅⠀", "⢃⠀", "⡃⠀", "⠍⠀", "⢋⠀", "⡋⠀", "⠍⠁", "⢋⠁", "⡋⠁", "⠍⠉", "⠋⠉", "⠋⠉", "⠉⠙", "⠉⠙", "⠉⠩", "⠈⢙", "⠈⡙", "⢈⠩", "⡀⢙", "⠄⡙", "⢂⠩", "⡂⢘", "⠅⡘", "⢃⠨", "⡃⢐", "⠍⡐", "⢋⠠", "⡋⢀", "⠍⡁", "⢋⠁", "⡋⠁", "⠍⠉", "⠋⠉", "⠋⠉", "⠉⠙", "⠉⠙", "⠉⠩", "⠈⢙", "⠈⡙", "⠈⠩", "⠀⢙", "⠀⡙", "⠀⠩", "⠀⢘", "⠀⡘", "⠀⠨", "⠀⢐", "⠀⡐", "⠀⠠", "⠀⢀", "⠀⡀"];
        let short_spinner_state = 0;
        let short_spinner_states = ["⣷", "⣯", "⣟", "⡿", "⢿", "⣻", "⣽", "⣾"];
        setInterval(() => {
            long_spinners.forEach(spinner => {
                spinner.innerHTML = long_spinner_states[long_spinner_state % long_spinner_states.length];
            });
            short_spinners.forEach(spinner => {
                spinner.innerHTML = short_spinner_states[short_spinner_state % short_spinner_states.length];
            });
            short_spinner_state++;
            long_spinner_state++;
        }, 100);

        /* UI Event listeners */

        // serial connect / disconnect / telem recv
        let serial_connection_state = document.querySelector('#serial_connection_state');
        let telemetry_last_received = document.querySelector('#telemetry_last_received_time');
        let connect_button = document.querySelector('#serial_connect');
        let last_connection_time;
        connect_button.addEventListener('click', () => {
            serial_connect(
                (e) => {
                    serial_connection_state.innerHTML = "connected";
                    serial_connection_state.style.color = "lightgreen";
                    connect_button.style.display = "none";
                },
                (e) => {
                    serial_connection_state.innerHTML = "disconnected";
                    serial_connection_state.style.color = "salmon";
                    connect_button.style.display = "block";
                },
                (telem) => {
                    last_connection_time = new Date();
                    handle_telem_recv(telem);
                }
            )
        });

        // Update telem last recv
        setInterval(() => {
            if (!last_connection_time) {
                telemetry_last_received.style.color = "salmon";
                telemetry_last_received.innerHTML = "never"
                return;
            }
            let latency = new Date() - last_connection_time;
            if (latency < 2000) {
                telemetry_last_received.style.color = "lightgreen";
            } else {
                telemetry_last_received.style.color = "salmon";
            }
            telemetry_last_received.innerHTML = (latency / 1000).toFixed(2) + "s ago"
        }, 100);


        // Error message for short uid
        // document.querySelector('#set_uid').addEventListener('click', () => {
        //     let uid = document.querySelector('#uid_input').value;
        //     document.querySelector('#uid_length_error').hidden = true;
        //     set_uid(uid, () => {
        //         document.querySelector('#uid_length_error').hidden = false;
        //     });
        // });

        // Handle network selection
        let selected_network;
        let network_input_placeholder = document.querySelector('#network_password_input_block > .placeholder');
        let network_input_content = document.querySelectorAll('#network_password_input_block > :not(.placeholder)');
        function network_on_click(netork) {
            selected_network = network;
            network_input_placeholder.style.display = 'none';
            network_input_content.forEach(item => {item.style.display = 'block'});
        }

        /* Data view update */

        let identification_list = document.querySelector('#identification_list');
        let network_list = document.querySelector('#network_list');
        let bit_list = document.querySelector('#built_in_test_list');

        let wifi_strength_indicators = ["[••••]", "[••• ]", "[••  ]", "[•   ]"];

        // We have preact at home
        let state_cache;

        function handle_telem_recv(telem) {
            let identification_list_content = "";
            let network_list_content = "";
            let bit_list_content = "";
            let state = telem?.Ok?.State;
            if (state) {
                if (JSON.stringify(state) === JSON.stringify(state_cache)) {
                    // No DOM update required
                    return;
                }

                // Identification
                identification_list_content = "";
                identification_list_content += `
                    <li>
                        Unique ID: ${state?.uid}
                    </li>
                    <li>
                        IP: ${state?.ip ? state?.ip : '<span style="color:#FDFD96" class="short_spinner">${short_spinner_states[(short_spinner_state) % short_spinner_states.length]}</span>'}
                    </li>
                `;
                if (state?.uid !== state_cache?.uid || state?.ip !== state_cache?.ip) {
                    identification_list.innerHTML = identification_list_content;
                }

                // Connectivity
                let current_connection = state?.current_network_connection?.replace(/\0/g, '').trim();
                state?.available_network_connections.sort((a, b) => {
                    if (a?.ssid.replace(/\0/g, '').trim() == current_connection) {return -1};
                    if (b?.ssid.replace(/\0/g, '').trim() == current_connection) {return 1};
                    return a?.strength - b?.strength;
                });
                if (JSON.stringify(state?.available_network_connections) !== JSON.stringify(state_cache?.available_network_connections)) {
                    if (state?.available_network_connections.length == 0) {
                        network_list_content = `
                        <li>
                            <p style="margin: 0px;">No networks available</p>
                        </li>
                        `;
                    } else {
                        state?.available_network_connections?.forEach(connection => {
                            let strength = wifi_strength_indicators[
                                Math.max(
                                    Math.min(
                                        Math.floor(connection?.strength / 20) - 1,
                                        wifi_strength_indicators.length - 1
                                    ),
                                    0
                                )
                            ];
                            network_list_content += `
                            <li>
                                <span style="margin: 0px;"> ${connection?.ssid} </span> 
                                ${connection?.ssid.replace(/\0/g, '').trim() == current_connection ?
                                    "<- currently connected" :
                                    `<pre style='float: right; margin-top: 0px;'>${strength} | <a >[ connect ]</a></pre>`
                                } 
                            </li>
                        `;
                        });
                    }
                    network_list.innerHTML = network_list_content;
                }

                // Built In Test (BIT)
                let result_map = {
                    "Waiting": ["#FDFD96", `<span class="short_spinner">${short_spinner_states[(short_spinner_state) % short_spinner_states.length]}</span>`],
                    "Pass": ["lightgreen", "✓"],
                    "Fail": ["salmon", "✖"],
                };
                if (JSON.stringify(state?.built_in_test) !== JSON.stringify(state_cache?.built_in_test)) {
                    Object.keys(state?.built_in_test).forEach(test_name => {
                        let check_list = "";
                        state?.built_in_test[test_name]?.forEach(check => {
                            let content = result_map[check.result];
                            check_list += `<li><span style="color: ${content[0]};">${content[1]}</span> ${check.name}</li>`;
                            check_list += "\n";
                        });
                        bit_list_content += `
                        <li>
                            <p style="margin: 0px;">${test_name}</p>
                            <ul>
                                ${check_list != "" ? check_list : "<li>No checks found!</li>"}
                            </ul>
                        </li>
                        `;
                    })
                    bit_list.innerHTML = bit_list_content;
                }

                // Update cache
                state_cache = state;

                // New spinners may have been added
                long_spinners = document.querySelectorAll('.spinner');
                short_spinners = document.querySelectorAll('.short_spinner');
            }
        }

    </script>
</head>

<body>
    <div style="margin-top: 10ch;" class="tree">
        <ul>
            <p style="margin: 0px;"><strong>Mote</strong></p>
            <li class="preconnection">
                Serial: <span style="color: salmon" id="serial_connection_state">disconnected</span>
            </li>
            <li>
                Telemetry last received: <span style="color: salmon" id="telemetry_last_received_time">never</span>
            </li>
            <li>
                <p style="margin: 0px;"><strong>Identification</strong></p>
                <ul id="identification_list">
                    <li><span class="spinner">⢀⠀</span></li>
                </ul>
            </li>
            <li>
                <p style="margin: 0px;"><strong>Detected Networks</strong></p>
                <ul id="network_list">
                    <li><span class="spinner">⢀⠀</span></li>
                </ul>
            </li>
            <li>
                <p style="margin: 0px;"><strong>Diagnositics</strong></p>
                <ul id="built_in_test_list">
                    <li><span class="spinner">⢀⠀</span></li>
                </ul>
            </li>
        </ul>
    </div>

    <div>
        <button id="serial_connect">Connect</button>
    </div>
</body>

</html>
